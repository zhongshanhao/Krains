(window.webpackJsonp=window.webpackJsonp||[]).push([[111],{591:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("项目背景")]),s._v(" "),t("p",[s._v("图像围栏网站后端代码编写和维护")]),s._v(" "),t("p",[s._v("如写接口返回用户信息、摄像头信息、抓拍信息、处理用户的请求")]),s._v(" "),t("p",[s._v("如用户上传一张图片，去掉抽特征服务")]),s._v(" "),t("p",[s._v("架构")]),s._v(" "),t("p",[s._v("前后端分离、后端springboot、spring")]),s._v(" "),t("p",[s._v("resource-manager：包含资源管理和权限管理两个模块；其中参与了资源管理模块的设计与实现，实现了一个线程安全、缓存和持久化、条件查询和包含索引查询加速的底层资源库。")]),s._v(" "),t("p",[s._v("图片存储服务：kv")]),s._v(" "),t("p",[s._v("静态库的meta在mongo，动态库在es，这俩都是只存个uri，图片本身在kv")]),s._v(" "),t("p",[s._v("LruCache机制")]),s._v(" "),t("p",[s._v("背景：网站上经常展示一些摄像头抓拍的图片、用户人像库的图片，而这些图片存储在数据库中，每次获取图片需要从远端数据库中拿，这样延迟较高，限制了网站的qps")]),s._v(" "),t("p",[s._v("为了能够有效提高图像围栏的性能，引入了一种带有清退机制的缓存结构LruCache(Least Recently Used Cache)，在目前的系统中，使用LruCache + 键值存储数据库的机制将远端数据变为本地缓存数据，不仅能够降低平均获取信息的耗时，而且通过一定的清退机制，也可以维持服务内存占用在安全区间。")]),s._v(" "),t("p",[s._v("LruCache内部维护一个双向链表和一个映射表。链表按照使用顺序存储缓存数据，越早使用的数据越靠近链表尾部，越晚使用的数据越靠近链表头部；映射表通过Key-Value结构，提供高效的查找操作，通过键值可以判断某一数据是否缓存，如果缓存直接获取缓存数据所属的链表节点，进一步获取缓存数据。LruCache结构图如下所示，上半部分是双向链表，下半部分是映射表（不一定有序）。双向链表中value_1所处位置为链表头部，value_N所处位置为链表尾部。")]),s._v(" "),t("p",[t("img",{attrs:{src:"D:_temp%5C%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87%5C51554b90bd36dfa46aa1c2338cfbe3b56921.png",alt:"51554b90bd36dfa46aa1c2338cfbe3b56921"}})]),s._v(" "),t("p",[s._v("接口设计")]),s._v(" "),t("div",{staticClass:"language-Java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LruCache")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("put")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" resource"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("实现")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LruCacheImpl")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LruCache")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[t("code",[s._v("get()")]),s._v("操作，取数据时，先判断数据在不在缓存中")]),s._v(" "),t("ul",[t("li",[s._v("不在就到数据库中取出数据，插入到缓存（链表头）中")]),s._v(" "),t("li",[s._v("在就将节点移动到链表头中")])]),s._v(" "),t("p",[t("code",[s._v("put()")]),s._v("操作，放数据库，然后更新缓存")]),s._v(" "),t("p",[s._v("线程安全的LruCache在读写操作中，全部使用锁做临界区保护，确保缓存使用是线程安全的。")]),s._v(" "),t("blockquote",[t("p",[s._v("get和put的时候都得加锁保证线程安全问题，在缓存不命中的情况下，需要先加锁，并到数据库中取数据，然后在写cache，比不用cache更慢。因此，使用LruCache的前提是保证缓存的命中率")])]),s._v(" "),t("p",[t("a",{attrs:{href:"https://tech.meituan.com/2018/12/20/lrucache-practice-dsp.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考文章"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("缓存一致性")])])}),[],!1,null,null,null);a.default=e.exports}}]);